generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/////////////////////////////////////////////////
// USERS & ORGANIZATIONS
/////////////////////////////////////////////////

model User {
  id             String        @id @default(cuid())
  email          String        @unique
  name           String?
  password       String?       // Hashed password
  role           Role          @default(STAFF)
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id])

  sessions       Session[]
  communications Communication[]
  auditLogs      AuditLog[]
  passwordResetTokens PasswordResetToken[]
  meetings       Meeting[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
}

model Session {
  id             String   @id @default(cuid())
  userId         String
  user           User     @relation(fields: [userId], references: [id])

  token          String   @unique
  refreshToken   String?  @unique
  userAgent      String?
  ipAddress      String?

  expiresAt      DateTime
  lastActivityAt DateTime @default(now())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
}

model AuditLog {
  id             String        @id @default(cuid())
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id])
  userId         String?
  user           User?         @relation(fields: [userId], references: [id])

  action     String
  entityType String?
  entityId   String?
  details    Json?
  ipAddress  String?
  userAgent  String?

  createdAt DateTime @default(now())

  @@index([userId, action])
  @@index([organizationId, createdAt])
}

model PasswordResetToken {
  id        String @id @default(cuid())
  userId    String
  user      User   @relation(fields: [userId], references: [id])

  token     String @unique
  expiresAt DateTime

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
}

enum Role {
  ADMIN
  STAFF
}

model Organization {
  id       String @id @default(cuid())
  name     String
  slug     String @unique
  settings Json?

  users          User[]
  donors         Donor[]
  donations      Donation[]
  campaigns      Campaign[]
  communications Communication[]
  pledges        Pledge[]
  auditLogs      AuditLog[]
  meetings       Meeting[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/////////////////////////////////////////////////
// DONORS
/////////////////////////////////////////////////

model Donor {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  firstName        String
  lastName         String
  email            String?
  phone            String?
  preferredContact PreferredContact @default(EMAIL)

  relationshipStage RelationshipStage @default(NEW)
  status            DonorStatus       @default(ACTIVE)

  notes         String?
  personalNotes Json?

  address        Address?
  donations      Donation[]
  pledges        Pledge[]
  interests      DonorInterest[]
  tags           DonorTag[]
  communications Communication[]
  softCredits    SoftCredit[]
  meetings       Meeting[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId, lastName])
  @@index([organizationId, email])
}

model Address {
  id      String  @id @default(cuid())
  street  String?
  city    String?
  state   String?
  zipCode String?

  donorId String @unique
  donor   Donor  @relation(fields: [donorId], references: [id])
}

/////////////////////////////////////////////////
// INTERESTS & TAGS
/////////////////////////////////////////////////

model Interest {
  id   String @id @default(cuid())
  name String @unique

  donors DonorInterest[]
}

model DonorInterest {
  donorId    String
  interestId String

  donor    Donor    @relation(fields: [donorId], references: [id])
  interest Interest @relation(fields: [interestId], references: [id])

  @@id([donorId, interestId])
}

model Tag {
  id   String @id @default(cuid())
  name String @unique

  donors DonorTag[]
}

model DonorTag {
  donorId String
  tagId   String

  donor Donor @relation(fields: [donorId], references: [id])
  tag   Tag   @relation(fields: [tagId], references: [id])

  @@id([donorId, tagId])
}

/////////////////////////////////////////////////
// PLEDGES
/////////////////////////////////////////////////

model Pledge {
  id             String @id @default(cuid())
  organizationId String
  donorId        String

  organization Organization @relation(fields: [organizationId], references: [id])
  donor        Donor        @relation(fields: [donorId], references: [id])

  totalAmount Float
  amountPaid  Float           @default(0)
  frequency   PledgeFrequency
  startDate   DateTime
  endDate     DateTime?
  status      PledgeStatus    @default(ACTIVE)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum PledgeStatus {
  ACTIVE
  COMPLETED
  CANCELLED
}

/////////////////////////////////////////////////
// DONATIONS
/////////////////////////////////////////////////

model Donation {
  id             String @id @default(cuid())
  organizationId String
  donorId        String

  organization Organization @relation(fields: [organizationId], references: [id])
  donor        Donor        @relation(fields: [donorId], references: [id])

  amount        Float
  currency      String        @default("USD")
  date          DateTime      @default(now())
  paymentMethod PaymentMethod
  transactionId String?

  campaignId String?
  campaign   Campaign? @relation(fields: [campaignId], references: [id])

  type        DonationType @default(ONE_TIME)
  isRecurring Boolean      @default(false)
  recurringId String?

  isTribute   Boolean      @default(false)
  tributeName String?
  tributeType TributeType?

  status    DonationStatus @default(COMPLETED)
  fees      Float?         @default(0)
  netAmount Float?

  softCredits    SoftCredit[]
  communications Communication[]

  notes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId, date])
  @@index([donorId])
  @@index([campaignId])
}

model SoftCredit {
  id         String @id @default(cuid())
  donationId String
  donorId    String

  donation Donation @relation(fields: [donationId], references: [id])
  donor    Donor    @relation(fields: [donorId], references: [id])

  amount Float
  reason String?

  createdAt DateTime @default(now())
}

/////////////////////////////////////////////////
// CAMPAIGNS
/////////////////////////////////////////////////

model Campaign {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  name        String
  description String?
  goal        Float?
  startDate   DateTime?
  endDate     DateTime?
  status      CampaignStatus @default(ACTIVE)

  donations      Donation[]
  communications Communication[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/////////////////////////////////////////////////
// COMMUNICATIONS
/////////////////////////////////////////////////

model Communication {
  id             String @id @default(cuid())
  organizationId String
  donorId        String

  organization Organization @relation(fields: [organizationId], references: [id])
  donor        Donor        @relation(fields: [donorId], references: [id])

  type      CommunicationType
  direction Direction @default(OUTBOUND)

  subject String?
  content String?
  summary String?
  meetingUrl String?

  status    CommunicationStatus @default(SENT)
  sentAt    DateTime?
  openedAt  DateTime?
  clickedAt DateTime?

  relatedDonationId String?
  relatedDonation   Donation? @relation(fields: [relatedDonationId], references: [id])

  campaignId String?
  campaign   Campaign? @relation(fields: [campaignId], references: [id])

  requiresFollowUp Boolean @default(false)
  followUpDate     DateTime?

  userId String?
  user   User? @relation(fields: [userId], references: [id])

  meeting Meeting?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([donorId, sentAt])
  @@index([organizationId, type])
}

/////////////////////////////////////////////////
// MEETINGS
/////////////////////////////////////////////////

model Meeting {
  id             String @id @default(cuid())
  organizationId String
  donorId        String
  userId         String

  organization Organization @relation(fields: [organizationId], references: [id])
  donor        Donor        @relation(fields: [donorId], references: [id])
  user         User         @relation(fields: [userId], references: [id])

  title       String
  description String?

  zoomMeetingId String? @unique
  zoomJoinUrl   String?
  zoomStartUrl  String?
  zoomPassword  String?

  startTime DateTime
  endTime   DateTime
  duration  Int

  status MeetingStatus @default(SCHEDULED)

  communication Communication? @relation(fields: [communicationId], references: [id])
  communicationId String? @unique

  notes  String?
  agenda Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([donorId])
  @@index([userId])
  @@index([organizationId, startTime])
}

/////////////////////////////////////////////////
// ENUMS
/////////////////////////////////////////////////

enum PreferredContact {
  EMAIL
  PHONE
  MAIL
  ANY
}

enum RelationshipStage {
  NEW
  CULTIVATION
  ASK_READY
  STEWARDSHIP
  MAJOR_GIFT
  LEGACY
}

enum PledgeFrequency {
  MONTHLY
  QUARTERLY
  ANNUALLY
  CUSTOM
}

enum DonorStatus {
  ACTIVE
  LAPSED
  PROSPECT
  INACTIVE
}

enum PaymentMethod {
  CREDIT_CARD
  BANK_TRANSFER
  CHECK
  CASH
  STOCK
  OTHER
}

enum DonationType {
  ONE_TIME
  PLEDGE_PAYMENT
  RECURRING
  MATCHING
}

enum TributeType {
  MEMORIAL
  HONOR
  CELEBRATION
}

enum DonationStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum CampaignStatus {
  DRAFT
  ACTIVE
  COMPLETED
  ARCHIVED
}

enum CommunicationType {
  EMAIL
  PHONE_CALL
  MEETING
  THANK_YOU_NOTE
  NEWSLETTER
  EVENT_INVITATION
  FOLLOW_UP
}

enum Direction {
  INBOUND
  OUTBOUND
}

enum CommunicationStatus {
  DRAFT
  SENT
  DELIVERED
  OPENED
  CLICKED
  BOUNCED
  FAILED
}

enum MeetingStatus {
  SCHEDULED
  COMPLETED
  CANCELLED
  RESCHEDULED
}
